---
layout: post
title: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloud-Init –≤ Proxmox
categories: pve
---
–î–æ–º–∞—à–Ω—è—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –ø—Ä–µ–¥–ø–æ–ª–∞–≥–µ—Ç —á–∞—Å—Ç–æ–µ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –∏ –µ—Å–ª–∏ –±—ã –≤ –º–∏—Ä–µ –±—ã–ª —á–µ–º–ø–∏–æ–Ω–∞—Ç speedrun –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Debian - —è –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –±—ã –ø–æ–±–µ–¥–∏–ª.
–í –æ–±—â–µ–º, –Ω–∞–¥–æ–µ–ª–æ –º–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞–≤–∞—Ç—å, sudo —Å—Ç–∞–≤–∏—Ç—å, dvd –∏–∑ source.list —É–±–∏—Ä–∞—Ç—å –∏ –ø—Ä–æ—á–∏–µ —Ä–∞–±–æ—Å—Ç–∏ –≥–æ–ª–æ–π —Å–∏—Å—Ç–µ–º—ã. –ë—ã–ª–∞ –º—ã—Å–ª—å —Å–¥–µ–ª–∞—Ç—å —Å–≤–æ–π –æ–±—Ä–∞–∑, –Ω–æ –ø—Ä–∏–±–∏–≤–∞—Ç—å –≥–≤–æ–∑–¥—è–º–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ—â–∏ –Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å.
–° pve —è –∑–Ω–∞–∫–æ–º –¥–∞–≤–Ω–æ, –Ω–æ –º–Ω–æ–≥–∏–µ –≤–µ—â–∏ –¥–æ —Å–∏—Ö –ø–æ—Ä –Ω–µ –∑–Ω–∞—é. –ü—Ä–∏—à–ª–æ –≤—Ä–µ–º—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å Cloud-init.

#### –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π —Ç–∞–∫–æ–π:
1. –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∫—É
2. –ü–æ–¥–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –µ–µ
3. –°–¥–µ–ª–∞—Ç—å –µ–µ —à–∞–±–ª–æ–Ω–æ–º
4. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å n-–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑ –ø—Ä–∏–º–µ–Ω—è—è –Ω—É–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª–∫—É
```
qm create 9001 --name debian-cloud --memory 2048 --net0 virtio,bridge=vmbr0
```
–î–æ–±–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–π –¥–∏—Å–∫ –∏ ISO
```
qm set 9001 --cdrom local:iso/<iso.img>
qm set 9001 --scsi0 local-lvm:disk-0
```
–ó–∞–ø—É—Å–∫–∞–µ–º –í–ú
```
qm start 9001
```
–î–∞–ª—å—à–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É. –†–∞–∑—Ä–µ—à–∞–µ–º SSH, —Å–∏—Å—Ç–µ–º—É –Ω–µ —à–∏—Ñ—Ä—É–µ–º.
–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–µ–º cloud-init (–∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –í–ú)
```
apt update
apt install -y cloud-init
```
–í—ã–∫–ª—é—á–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–∏—Å–∫ cloud-init
```
qm set 9001 --ide2 local-lvm:cloudinit
```
–£–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Å–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π
```
qm set 9001 --boot c --bootdisk scsi0
```

–î–∞–ª—å—à–µ —É –Ω–∞—Å –µ—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–Ω–∞—Ç–∞:
–ü–µ—Ä–≤—ã–π, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GUI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cloud-init (–º–∞–ª–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
–í—Ç–æ—Ä–æ–π, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å yaml —Å–Ω–∏–ø–ø–µ—Ç

#### –í –ø–µ—Ä–≤–æ–º —Å–ª—É—á–∞–π –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ GUI 
–í–æ –≤–∫–ª–∞–¥–∫–µ –≤–∏—Ä—Ç—É–∞–ª–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª Cloud-Init –∏ –Ω–∞—Å—Ç—Ä–∏–≤–∞–µ–º –Ω–∞–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –ñ–º–µ–º "Regenerate Image"
–î–∞–ª–µ–µ –æ—á–∏—â–∞–µ–º cloud-init –∏ –≤—ã–∫–ª—é—á–∞–µ–º –í–ú(–∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –í–ú)
```
cloud-init clean
sudo poweroff
```
–ü—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –º—ã—à–∏ –∫–ª–∏–∫–∞–µ–º –ø–æ –Ω–∞—à–µ–π –í–ú –∏ –≤—ã–±–∏—Ä–∞–µ–º Convert to Template.
–¢–µ–ø–µ—Ä—å –Ω–∞—à–∞ –í–ú —Å—Ç–∞–ª–∞ —à–∞–±–ª–æ–Ω–æ–º.
–ï—â–µ —Ä–∞–∑ –∫–ª–∏–∫–∞–µ–º –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –ø–æ –í–ú –∏ –≤—ã–±–∏—Ä–∞–µ–º "Clone"
–£–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –∏ VM ID
–í—ã–±–µ—Ä–∞–µ–º —Ç–∏–ø –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
- Linked Clone ‚Äî –±—ã—Å—Ç—Ä–µ–µ –∏ —ç–∫–æ–Ω–æ–º–∏—Ç –º–µ—Å—Ç–æ.
- Full Clone ‚Äî –∫–æ–ø–∏—è —à–∞–±–ª–æ–Ω–∞ (–±–æ–ª—å—à–µ, –Ω–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è).
–ù–∞–∂–º–∞–µ–º "Clone" –∏ –∑–∞–ø—É—Å–∫–∞–µ–º. 

#### –í–æ –≤—Ç–æ—Ä–æ–º —Å–ª—É—á–∞–µ –º—ã —Å–æ–∑–¥–∞–µ–º Snippet.
–ü–µ—Ä–≤—ã–º –¥–µ–ª–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ snippet –≤–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
Datacenter ‚Üí Storage ‚Üí local, –≤ –ø–æ–ª–µ Content –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–∞–ª–æ—á–∫–∞ –Ω–∞–ø—Ä–æ—Ç–∏–≤ Snippets.
–î–∞–ª–µ–µ —Å–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω
```
nano /var/lib/vz/snippets/user-data.yaml
```
–í –º–æ–µ–º —Å–ª—É—á–∞–µ –ø—Ä–∏–º–µ—Ä–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:
```
#cloud-config
hostname: testvm
fqdn: testvm.local

users:
  - name: username
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3...

packages:
  - htop
  - curl
  - git

runcmd:
  - echo "Hello from Cloud-Init" > /home/devuser/hello.txt
  - systemctl restart ssh


final_message: "Cloud-Init setup complite üéâ"
```
–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∏–ø–ø–µ—Ç–∞, –∫–ª–æ–Ω–∏—Ä—É–µ–º –í–ú –∏ –ø—Ä–∏—Ü–µ–ø–ª—è–µ–º –≤ –Ω–µ–π —Å–Ω–∏–ø–ø–µ—Ç
```
qm set 9002 --cicustom "user=local:snippets/user-data.yaml"
```
–û—Å—Ç–∞–µ—Ç—Å—è –∑–∞–π—Ç–∏ –≤–æ –≤–∫–ª–∞–¥–∫—É cloud-init –∏ –Ω–∞–∂–∞—Ç—å "Regenerate Image"
–ó–∞–ø—É—Å–∫–∞–µ–º –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è

–í–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç: –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ .yaml —Ñ–∞–π–ª –¥–ª—è –Ω–∞–π—Å—Ç—Ä–æ–π–∫–∏ - –æ—Å—Ç–∞–≤—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è cloud-init –≤ gui –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö, –∏–Ω–∞—á–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —Å—Ä–∞–∑—É –∏–∑ –¥–≤—É—Ö –º–µ—Å—Ç.